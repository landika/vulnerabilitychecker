import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin
from pprint import pprint

class WebSecurityScanner:
    """
    Kode Program simpel web security scanner untuk mengidenfitikasi kerentanan xss dan sql injection
    """

    def __init__(self, user_agent):
        """
        Inisialisasi WebSecurityScanner dengan user agent tertentu
        
        Parameters:
        - user_agent (str): The user agent yang akan digunakan untuk request HTTP.
        """
        self.session = requests.Session()
        self.session.headers["User-Agent"] = user_agent

    def get_all_forms(self, url):
        """
        Fungsi get all untuk mendapatkan semua form HTML dari URL tertentu

        Parameters:
        - url (str): URL dari form yang akan diambil nilainya.

        Returns:
        - list: List dari form HTML.
        """
        soup = BeautifulSoup(self.session.get(url).content, "html.parser")
        return soup.find_all("form")

    def get_form_details(self, form):
        """
        Mengambil informasi detail dari form HTML 

        Parameters:
        - form (bs4.element.Tag): elemen form HTML.

        Returns:
        - dict: Dictionary terkait detail form.
        """
        details = {
            "action": form.attrs.get("action", "").lower(),
            "method": form.attrs.get("method", "get").lower(),
            "inputs": [
                {"type": input_tag.attrs.get("type", "text"), "name": input_tag.attrs.get("name")}
                for input_tag in form.find_all("input")
            ],
        }
        return details

    def submit_form(self, form_details, url, value):
        """
        Melakukan submit pada form tertentu dengan payload malicious dan mengembalikan respon HTTP
     
        Parameters:
        - form_details (dict): Dictionary terkait detail form.
        - url (str): URL awal yang terdapat form.
        - value (str): isian Payload value untuk input teks dan pencarian.

        Returns:
        - requests.Response: respon HTTP setelah pengisian form.
        """
        target_url = urljoin(url, form_details["action"])
        data = {
            input["name"]: value if input["type"] in ["text", "search"] else input.get("value", "")
            for input in form_details["inputs"]
        }
        print(f"[+] Mengirimkan payload malicious ke {target_url}")
        print(f"[+] Data: {data}")
        return self.session.post(target_url, data=data) if form_details["method"] == "post" else self.session.get(target_url, params=data)

    def is_vulnerable(self, response):
        """
        Periksa apakah halaman tertentu rentan terhadap SQL injection berdasarkan responnya.
       
        Parameters:
        - response (requests.Response): respon HTTP.

        Returns:
        - bool: True if halaman mempunyai kerentanan, False jka tidak.
        """
        errors = [
            "terdapat error pada sql syntax anda;",
            "warning: mysql",
            "tanda kutip tidak tertutup setelah string karakter",
            "string yang dikutip tidak diakhiri dengan benar",
        ]
        return any(error in response.content.decode().lower() for error in errors)

    def scan_xss(self, url):
        """
        Mengidentifikasi form terhadap kerentanan XSS  pada URL tertentu
        
        Parameters:
        - url (str): URL yang akan dilakukan scan.

        Returns:
        - bool: True if halaman mempunyai kerentanan, False jka tidak.
        """
        forms = self.get_all_forms(url)
        print(f"[+] Terdeteksi {len(forms)} pada form {url}.")
        js_script = "<Script>alert('hi')</script>"
        is_vulnerable = False
        for form in forms:
            form_details = self.get_form_details(form)
            content = self.submit_form(form_details, url, js_script).content.decode()
            if js_script in content:
                print(f"[+] XSS terdeteksi pada {url}")
                print(f"[*] Detail Form:")
                pprint(form_details)
                is_vulnerable = True
        return is_vulnerable

    def scan_sql_injection(self, url):
        """
        Melakukan pengetesan terhadap URL dan form HTL untuk celah kerentanan SQL Injection

        Parameters:
        - url (str): URL yang akan dilakukan scan.
        """
        for c in "\"'":
            new_url = f"{url}{c}"
            print("[!] Scanning", new_url)
            res = self.session.get(new_url)
            if self.is_vulnerable(res):
                print("[+] Terdeteksi Kerentanan SQL Injection, link:", new_url)
                return
        forms = self.get_all_forms(url)
        print(f"[+] Terdeteksi {len(forms)} pada form {url}.")
        for form in forms:
            form_details = self.get_form_details(form)
            for c in "\"'":
                data = {
                    input_tag["name"]: input_tag["value"] + c
                    if input_tag["type"] == "hidden" or input_tag["value"]
                    else f"test{c}"
                    for input_tag in form_details["inputs"]
                    if input_tag["type"] != "submit"
                }
                form_url = urljoin(url, form_details["action"])
                res = self.session.post(form_url, data=data) if form_details["method"] == "post" else self.session.get(form_url, params=data)
                if self.is_vulnerable(res):
                    print("[+] Terdeteksi Kerentanan SQL Injection, link:", form_url)
                    print("[+] Form:")
                    pprint(form_details)
                    break

if __name__ == "__main__":
    # Example usage for a specific URL
    url = "URL"
    url = "URL"
    print("check_sqli")
    scanner = WebSecurityScanner(user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36")
    scanner.scan_sql_injection(url)
    print("check_xss")
    print(scanner.scan_xss(url))


#Contoh URL Website yang terdapat kerentanan XSS : https://xss-game.appspot.com/level1/frame
#Contoh URL Website yang terdapat kerentanan SQL Injection : http://testphp.vulnweb.com/artists.php?artist=1
